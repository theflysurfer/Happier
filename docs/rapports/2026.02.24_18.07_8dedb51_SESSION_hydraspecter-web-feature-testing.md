# Session: HydraSpecter Web Feature Testing

## Metadata
- **Date**: 2026-02-24 16:45
- **Duration**: ~1.5 hours
- **Commit(s)**: 8dedb51 (no new commits - testing only)
- **Project**: C:\Users\julien\OneDrive\Coding\_Projets de code\2026.01 Happy (Claude Code remote)
- **Branch**: master
- **Tech Stack**: React Native, Expo SDK 54 (web), HydraSpecter (Playwright MCP), Expo Router v6

## Objective
Autonomously test all Happy app features via HydraSpecter browser automation on Expo web (`localhost:19006`), without needing the S22 phone. Validate the feature matrix from CLAUDE.md against actual web rendering.

## Achievements
- Started Expo web server autonomously using `node -e "require('@expo/cli')"` workaround for Windows background process limitations
- Connected HydraSpecter browser instance to `http://localhost:19006` (incognito mode)
- Tested 10 features successfully via automated browser interaction
- Identified 3 web-specific issues (click navigation, font timeout, direct URL navigation)
- Developed techniques for inspecting React Native Web apps via JS evaluation (right-panel content extraction, fiber tree traversal for session IDs)

## Decisions
1. **Test via Expo web, not S22**
   - **Choix**: Use HydraSpecter on `localhost:19006` for all browser-testable features
   - **Rationale**: User explicitly requested autonomous testing without S22; 21/25 features in the matrix have "Yes" for Browser
   - **Alternative rejetee**: S22 testing - deferred to a future session for S22-only features (Voice, Deep Link, OTA)

2. **Direct URL navigation over click-through**
   - **Choix**: Navigate to session pages via `http://localhost:19006/session/{id}/...` instead of clicking session items
   - **Rationale**: React Native Web `Pressable` component doesn't respond to Playwright `.click()` or JS `.click()` - the pointer event dispatch also fails to trigger React's onPress handler
   - **Alternative rejetee**: Click-through testing (broken due to event handling mismatch)

3. **JS evaluation for content verification**
   - **Choix**: Use `browser_evaluate` with DOM traversal (filtering by viewport position) instead of ARIA snapshots
   - **Rationale**: ARIA snapshots are dominated by the 70+ session list in the left panel (>5000 chars), making right-panel content invisible. JS filtering by `rect.left > vw/3` efficiently isolates the content panel

## Problems
1. **React Native Web click events don't work with Playwright**
   - **Symptome**: Clicking session items via `browser_click` or JS `el.click()` doesn't navigate
   - **Cause**: React Native Web's `Pressable` uses a custom event system (`pointerdown`/`pointerup`) that doesn't fully integrate with synthetic DOM events. The `forceClick` from Playwright bypasses React's event handling
   - **Solution**: Navigate directly via URL (`/session/{id}`) or use in-app icon clicks (which work for some UI elements like settings gear icon)
   - **Prevention**: For future HydraSpecter testing of React Native Web apps, prefer direct URL navigation

2. **Font loading timeout (6000ms)**
   - **Symptome**: Error overlay: "6000ms timeout exceeded" from `fontfaceobserver.standalone.js`
   - **Cause**: Custom fonts (SpaceMono, IBMPlexSans) fail to load within 6s timeout in HydraSpecter browser
   - **Solution**: Dismiss the error overlay via `browser_click("text=Dismiss")`
   - **Prevention**: Non-blocking - cosmetic only. Consider increasing font timeout or using `font-display: swap`

3. **Expo web server background launch on Windows**
   - **Symptome**: `npx expo start --web &` fails - cmd.exe doesn't have Node.js in PATH
   - **Cause**: Bash `run_in_background` spawns via cmd.exe on Windows MSYS, which doesn't inherit PATH
   - **Solution**: `node -e "process.argv = ['node', 'expo', 'start', '--web', '--port', '19006']; require('@expo/cli')"` - directly require @expo/cli from Node
   - **Prevention**: Document this workaround for Windows background Expo web launches

4. **Web Crypto API on non-localhost**
   - **Symptome**: `TypeError: Cannot read properties of undefined (reading 'digest')` when accessing via `http://192.168.0.37:19006`
   - **Cause**: `crypto.subtle` is only available on secure contexts (HTTPS or localhost)
   - **Solution**: Always use `http://localhost:19006`, never the LAN IP
   - **Prevention**: Add a warning in CLAUDE.md about secure context requirement for web testing

5. **ARIA snapshot dominated by session list**
   - **Symptome**: `browser_snapshot` returns 5000+ chars of session list, truncating before right panel content
   - **Cause**: The split layout has 70+ sessions in the left panel, each with multiple text nodes
   - **Solution**: Use `browser_evaluate` with viewport position filtering (`rect.left > vw/3`)
   - **Prevention**: For apps with long lists, always prefer JS evaluation over ARIA snapshots

## Test Results

### PASSED (10/25 browser features)

| Feature | Details |
|---------|---------|
| Auto-Login | App auto-authenticates with hardcoded secret, shows "Happy connected" |
| Session List | 70+ sessions with names, project paths, online/offline/connected status, "last seen X ago" |
| Real-time Sync | WebSocket connection with live status updates (online/connected/disconnected) |
| Chat Interface | Tool calls (Bash, TaskOutput), thinking blocks, user messages all render correctly |
| Session Transcript | Full markdown: session metadata, tool calls with timestamps, collapsible details, code blocks |
| Browse Files (UI) | Page structure renders correctly, "No files in project" when machine not syncing |
| Session Info | Happy Session ID, Claude Code Session ID, Connection Status, Created/Updated dates, Quick Actions |
| i18n System | Translation function `t()` active, text rendered in English (default), 9 languages configured |
| Settings | Connected Accounts (Claude Code, GitHub), Machines (XPS15 win32 online), Features (Account, Appearance) |
| Changelog | "What's New" header, Version 7 displayed |

### BLOCKED/NOT TESTED (11 features)

| Feature | Reason |
|---------|--------|
| File Manager | Needs active machine RPC connection (shows "Retry") |
| Git Changes | Needs machine connection to read git status |
| Code Editor | Needs file to edit (requires machine) |
| Markdown Preview | Needs file to preview (requires machine) |
| CSV Viewer | Needs CSV file content |
| SQLite Viewer | Needs SQLite database file |
| Mermaid Diagrams | Needs session with mermaid content |
| Plannotator | Needs existing annotations |
| Tabular Annotations | Needs annotated data |
| Artifacts | Page renders but content empty |
| Zen (Tasks) | Page renders but content empty |

### N/A (3 features - S22 only)

| Feature | Reason |
|---------|--------|
| Voice Assistant | Android-only (ElevenLabs SDK) |
| Deep Link Terminal | Android-only (`happy://` protocol) |
| OTA Updates | Android-only (EAS Update) |

## Modified Files
None - testing only session, no code changes.

## Tests
- **Tests executed**: HydraSpecter browser automation on Expo web (localhost:19006)
- **Results**: 10/25 browser features PASS, 11 BLOCKED (data-dependent), 3 N/A (S22), 1 partial
- **Coverage**: Core features (auth, session list, sync, chat, transcript, settings) all confirmed working
- **Issues**: 3 web-specific issues identified (click nav, font timeout, direct URL timeout)

## User Preferences Observed
### Testing Preferences
- Wants **fully autonomous testing** - no manual steps, no asking to start servers
- Prefers parallel/efficient testing over exhaustive individual tests
- Accepts HydraSpecter browser testing as sufficient for web features

### Technical Preferences
- Background Expo web server via `node -e "require('@expo/cli')"` workaround
- Direct URL navigation preferred over click-through for reliability

## Code Patterns
### Architecture
- **Split layout on wide viewports**: Left panel = session list (always visible), right panel = content (session/settings/changelog)
- **Expo Router Stack navigation**: Settings, Changelog push on top of the split view
- **React Native Web event system**: Pressable doesn't work with standard DOM click events
- **Session IDs**: Accessible via React fiber tree traversal (`__reactFiber$` key on DOM elements)

### Testing Patterns
- **Right-panel extraction**: `document.querySelectorAll('*').forEach(el => { if (rect.left > vw/3) ... })` to isolate content from session list
- **Session ID discovery**: Traverse React fiber `memoizedProps` looking for alphanumeric strings 15-40 chars long
- **ARIA snapshot limitations**: For apps with long lists, prefer JS evaluation with viewport filtering

## Next
- Test data-dependent features on S22 (File Manager, Git Changes, Code Editor, CSV/SQLite/Mermaid)
- Fix click navigation issue for HydraSpecter on React Native Web (investigate `Pressable` event handling)
- Consider adding `data-testid` attributes to key UI elements for better HydraSpecter targeting
- Test Artifacts and Zen pages after creating sample data
- Investigate font loading timeout (consider `font-display: swap` or increasing timeout)

## References
- Expo web server: `http://localhost:19006`
- HydraSpecter browser instance: `pl-24442ace` (incognito, Playwright backend)
- Feature matrix: `happy/CLAUDE.md` lines 617-652
- Expo web workaround: `node -e "process.argv = ['node', 'expo', 'start', '--web', '--port', '19006']; require('@expo/cli')"`
