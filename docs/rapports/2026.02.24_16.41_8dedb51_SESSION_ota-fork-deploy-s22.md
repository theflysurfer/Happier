# Session: OTA Pipeline from Fork to S22 — End-to-End Setup

## Metadata
- **Date**: 2026-02-24 14:30
- **Duration**: ~2.5 hours
- **Commit(s)**: 8dedb512
- **Project**: 2026.01 Happy (Claude Code remote)
- **Branch**: master
- **Tech Stack**: React Native, Expo SDK 54, EAS Update, ADB, Gradle (Android), VPS Linux build

## Objective
Set up a complete OTA update pipeline where the fork (theflysurfer/Happier) is the single source of truth. Build a new APK with the fork's EAS projectId and runtimeVersion, install on S22, push an OTA update, and verify end-to-end.

## Achievements
- Diagnosed both installed APKs on S22 via `aapt2 dump` — discovered projectId and runtimeVersion mismatches
- Built new release APK on VPS from monorepo `feature/happier-port` branch with correct fork config (runtimeVersion "18", projectId `2c5ad154-...`)
- Installed APK on S22 via ADB, auto-login with hardcoded secret confirmed working
- Installed `eas-cli` v18.0.4 locally, user logged in as `jlt13400`
- Pushed first OTA update to production branch (update group `af7606a9-47dc-4044-973d-8865fda96f45`)
- Verified on device via ADB screenshots: app launches, authenticates, syncs sessions, shows terminal list

## Decisions
1. **Build from upstream monorepo, not standalone fork clone**
   - **Choix**: Used `~/happy/packages/happy-app/` (upstream monorepo) with `feature/happier-port` branch
   - **Rationale**: The standalone fork clone at `~/happier/happy/` failed because the libsodium binary patch (5.7MB) is Windows-specific (copies to `C:/tmp/` paths). The upstream monorepo's build infrastructure was already proven to work on Linux.
   - **Alternative rejetee**: Standalone fork build — libsodium CMake failure + cascading native build failures

2. **Use `com.slopus.happy.dev` bundle ID (not production)**
   - **Choix**: Dev bundle ID to avoid conflicting with the Play Store production app
   - **Rationale**: User can keep both apps on phone. OTA still works because channel is hardcoded to "production" in `app.config.js` regardless of `APP_ENV`.

3. **Reduce Gradle parallelism for VPS builds**
   - **Choix**: Set `org.gradle.workers.max=2` + `org.gradle.parallel=false`
   - **Rationale**: VPS has 15 GB RAM with no swap. Default parallelism + multiple Gradle daemons caused OOM kills. Sequential builds with 2 workers stay within memory limits.

## Problems
1. **APK projectId mismatch**
   - **Symptome**: Both installed APKs on S22 pointed to `4558dd3d-...` (upstream EAS) instead of our fork's `2c5ad154-...`
   - **Cause**: APKs were built from upstream repo on VPS, not from the fork
   - **Solution**: Built new APK from fork's branch with correct `app.config.js`
   - **Prevention**: Always verify APK config with `aapt2 dump` after building

2. **libsodium patch failure on Linux**
   - **Symptome**: `patch-package` cannot apply `@more-tech+react-native-libsodium+1.5.5.patch` on standalone fork clone
   - **Cause**: The 5.7MB binary patch contains Windows-specific paths (`C:/tmp/ls-lib/`, `C:/tmp/ls-src/`). On Linux, the binary diffs fail to apply even though path issues are irrelevant
   - **Solution**: Switched to upstream monorepo build where patches apply correctly (different node_modules tree structure)
   - **Prevention**: For fork-based VPS builds, apply the 3 text changes manually (rename `libsodium` → `libsodiumjni` in CMakeLists.txt, build.gradle, LibsodiumModule.java)

3. **VPS Gradle daemon OOM killed (twice)**
   - **Symptome**: `Gradle build daemon disappeared unexpectedly (it may have been killed or may have crashed)` after ~5 min of CMake compilation
   - **Cause**: Two Gradle builds running simultaneously (old upstream + new fork) consumed all 15 GB RAM. Load average hit 143.
   - **Solution**: (1) Killed all old Gradle/Kotlin daemons freeing ~7 GB. (2) Reduced parallelism: `workers.max=2`, `parallel=false`, JVM heap 3072m instead of 4096m.
   - **Prevention**: Always kill stale Gradle daemons before starting a new build. Consider adding swap on VPS.

4. **ADB disconnection mid-session**
   - **Symptome**: `adb devices` showed no devices after APK download
   - **Cause**: USB cable disconnected or phone locked/timed out
   - **Solution**: User reconnected USB cable
   - **Prevention**: Use `adb shell settings put global stay_on_while_plugged_in 2` during testing sessions

5. **Dirty git tree blocking OTA push**
   - **Symptome**: `eas update` refused with "working tree is dirty" due to untracked Python scripts
   - **Cause**: `requireCommit: true` in `eas.json` + untracked utility scripts in repo root
   - **Solution**: Added `fix_send.py` and `patch_*.py` to `.gitignore`, committed
   - **Prevention**: Keep repo clean; gitignore non-app utility scripts

## Modified Files
- `.gitignore` - Modified - Added `fix_send.py` and `patch_*.py` patterns

## Tests
- **Tests executes**: ADB screenshots to verify app state, `aapt2 dump` to verify APK metadata
- **Resultats**: App launches, auto-authenticates, syncs all sessions, shows terminal list with green "connected" status

## User Preferences Observed
### Commit & PR Preferences
- Co-authorship format includes Happy: `Co-Authored-By: Happy <yesreply@happy.engineering>`
- Commit messages follow conventional commits pattern
### Technical Preferences
- VPS build preferred over local Windows build (simpler, more reliable)
- `com.slopus.happy.dev` bundle ID preferred (coexists with production app)
- Prefers `eas login` locally rather than EXPO_TOKEN env var

## Code Patterns
### Architecture
- APK configuration inspection via `aapt2 dump resources` and `aapt2 dump xmltree` for AndroidManifest
- Expo runtimeVersion stored as Android string resource, not inline in manifest
- EAS `requireCommit: true` enforces clean git tree for OTA pushes
### Build
- VPS monorepo build: `~/happy/packages/happy-app/android/` with `feature/happier-port`
- Gradle properties critical after `prebuild --clean`: `Xmx3072m`, `MaxMetaspaceSize=1024m`, `arm64-v8a` only, `parallel=false`, `workers.max=2`
- Build time on VPS: ~10 min (with cached CMake artifacts from failed build)

## Next
- Monitor OTA update delivery on S22 (force-close + reopen to verify update applies)
- Consider adding swap on VPS to prevent future OOM during builds
- Future: when native deps change, bump runtimeVersion and rebuild APK
- Future: periodic upstream sync using `feature/happier-port` as conflict resolution reference

## References
- EAS Dashboard: https://expo.dev/accounts/jlt13400/projects/happy/updates/af7606a9-47dc-4044-973d-8865fda96f45
- Fork: https://github.com/theflysurfer/Happier
- VPS build dir: `automation@69.62.108.82:~/happier/happy/android/`
- APK verified config: runtimeVersion="18", projectId=`2c5ad154-57fd-417d-b434-ffcd710ea311`, channel="production"
