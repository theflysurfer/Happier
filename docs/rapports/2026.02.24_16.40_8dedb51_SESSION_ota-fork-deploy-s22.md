# Session: OTA Fork Deploy to S22 - Full Pipeline Setup

## Metadata
- **Date**: 2026-02-24 15:00
- **Duration**: ~1.5 hours
- **Commit(s)**: 8dedb512 (chore: ignore utility Python scripts in .gitignore)
- **Project**: C:\Users\julien\OneDrive\Coding\_Projets de code\2026.01 Happy (Claude Code remote)
- **Branch**: master
- **Tech Stack**: React Native, Expo SDK 54, EAS Update, ADB, Gradle (VPS Linux build), SSH

## Objective
Build a new APK from the fork (theflysurfer/Happier) on VPS and install it on the S22 phone, then verify the full OTA pipeline works from the fork as the single source of truth.

## Achievements
- Determined S22 APK runtimeVersions via APK extraction + aapt2: production=17, dev=20, both pointing to upstream EAS project `4558dd3d-...`
- Built new dev APK from fork on VPS (`~/happier/happy/`) with correct EAS projectId `2c5ad154-...` and runtimeVersion "18"
- Installed APK on S22 via ADB - auto-login worked, all sessions synced
- Installed `eas-cli` 18.0.4 globally on Windows
- Verified EAS login as `jlt13400`
- Successfully pushed first OTA update to production branch (update group `b2dd7ead-c53d-4508-a037-ccce44e5a7d3`)
- Verified app works on S22 via ADB screenshots - shows Terminals view with all active sessions

## Decisions
1. **VPS build over local/EAS cloud**
   - **Choix**: Build on VPS (Hostinger) from cloned fork
   - **Rationale**: Most reliable Linux build, no Windows path issues, ~20 min build time
   - **Alternative rejetee**: Local Windows build (complex 10-step process with junctions), EAS cloud (eas-cli not installed, requireCommit blocking)

2. **Dev bundle ID (com.slopus.happy.dev)**
   - **Choix**: Use development bundle ID for the fork APK
   - **Rationale**: Doesn't conflict with Play Store production app (`com.ex3ndr.happy`), user keeps both apps
   - **Alternative rejetee**: Production bundle ID would require uninstalling the Play Store version

3. **Gitignore utility scripts**
   - **Choix**: Added `fix_send.py` and `patch_*.py` to `.gitignore`
   - **Rationale**: `eas update` requires clean git tree (`requireCommit: true`), these scripts are outside the app directory and not part of the build

## Problems
1. **Both S22 APKs incompatible with fork OTA**
   - **Symptome**: OTA from fork would never reach installed APKs
   - **Cause**: Both APKs pointed to upstream EAS project `4558dd3d-...` (slopus account), not fork's `2c5ad154-...` (jlt13400). Plus runtimeVersion mismatch (17/20 vs 18)
   - **Solution**: Built new APK from fork with correct projectId and runtimeVersion
   - **Prevention**: Always verify APK EAS config with `aapt2 dump` before attempting OTA

2. **Gradle daemon OOM-killed on VPS (first attempt)**
   - **Symptome**: "Gradle build daemon disappeared unexpectedly" after ~15 min
   - **Cause**: Competing upstream build from previous session consuming ~8 GB RAM, only 15 GB total on VPS
   - **Solution**: Killed all old Gradle/Kotlin daemon processes (`kill -9` PIDs), freeing 7 GB. Retried build successfully
   - **Prevention**: Always check `ps aux | grep gradle` for stale processes before starting a build on VPS

3. **libsodium 5.7MB binary patch fails on VPS**
   - **Symptome**: `patch-package` could not apply `@more-tech+react-native-libsodium+1.5.5.patch`
   - **Cause**: Binary diffs in the patch file are unreliable across environments (contrary to CLAUDE.md claim that "On Linux, patch-package applies correctly")
   - **Solution**: Applied the 3 critical text changes manually via `sed`: renamed `libsodium` -> `libsodiumjni` in CMakeLists.txt and LibsodiumModule.java
   - **Prevention**: Update CLAUDE.md to note that libsodium manual patch may be needed on VPS too, not just Windows

4. **ANDROID_HOME not passed to Gradle on VPS**
   - **Symptome**: "SDK location not found" build failure
   - **Cause**: SSH environment variable escaping (`\$HOME`) didn't propagate correctly to Gradle subprocess
   - **Solution**: Created `android/local.properties` with `sdk.dir=/home/automation/android-sdk`
   - **Prevention**: Always create `local.properties` file instead of relying on env vars for VPS builds

5. **VPS SSH timeouts during heavy build**
   - **Symptome**: `Connection timed out during banner exchange` when VPS under 13+ GB memory pressure
   - **Cause**: System-wide memory pressure from Gradle build + Docker containers + other services
   - **Solution**: Waited for build to finish or memory to decrease. Background SSH session survived since it was established before the overload
   - **Prevention**: Stop non-essential Docker containers before building. Consider adding swap on VPS

## Modified Files
- `.gitignore` - Modified - Added `fix_send.py` and `patch_*.py` patterns to ignore utility scripts

## Tests
- **APK config verification**: `aapt2 dump resources` confirmed runtimeVersion="18" and correct EAS projectId
- **ADB install**: `adb install` succeeded with `Success`
- **Auto-login**: App launched, performed challenge-response auth, reached authenticated state (verified via ADB screenshot)
- **OTA push**: `eas update --branch production --platform android` succeeded, published update group `b2dd7ead-c53d-4508-a037-ccce44e5a7d3`
- **App functionality**: ADB screenshots confirmed Terminals view with all active sessions visible and connected

## Code Patterns
### Infrastructure
- **APK inspection technique**: `adb pull` APK from device + `aapt2 dump resources/xmltree` to extract expo-updates metadata without needing debuggable builds
- **VPS fork build**: Clone fork separately from upstream monorepo, standalone app structure (not monorepo), simpler build process
- **Memory management**: Kill stale Gradle/Kotlin daemons before starting new builds on memory-constrained VPS

## Next
- Update CLAUDE.md with VPS fork build instructions (separate from monorepo build)
- Document that libsodium patch fails on VPS too (not just Windows)
- Consider adding swap space on VPS for build stability
- Set up `yarn ota` shortcut to work from fork (currently configured for monorepo)
- Test OTA update delivery on next app restart (force-close + reopen)
- Clean up VPS: remove stale `~/happy/packages/happy-app/android/` build artifacts

## References
- EAS Dashboard: https://expo.dev/accounts/jlt13400/projects/happy/updates/b2dd7ead-c53d-4508-a037-ccce44e5a7d3
- Fork repo: https://github.com/theflysurfer/Happier
- VPS build path: `automation@69.62.108.82:~/happier/happy/`
- APK output: `~/happier/happy/android/app/build/outputs/apk/release/app-release.apk` (96 MB)
