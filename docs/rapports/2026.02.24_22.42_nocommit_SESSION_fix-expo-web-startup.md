# Session: Fix Expo Web Startup from Claude Code on Windows

## Metadata
- **Date**: 2026-02-24 22:42
- **Duration**: ~1 hour
- **Commit(s)**: nocommit (CLAUDE.md update pending)
- **Project**: C:\Users\julien\OneDrive\Coding\_Projets de code\2026.01 Happy (Claude Code remote)
- **Branch**: master
- **Tech Stack**: React Native, Expo SDK 54 (web), Metro Bundler, Windows MSYS bash

## Objective
Fix the Expo web server startup method from Claude Code on Windows. The previous `node -e "require('@expo/cli')"` approach broke on cold starts (empty Metro cache) because Metro's Jest worker child processes inherited the `-e` script and tried to start their own Expo servers, causing port conflict cascades. Find a reliable method and update CLAUDE.md.

## Achievements
- Identified the correct startup method: `node.exe ./node_modules/@expo/cli/build/bin/cli start --web --port 19006`
- Diagnosed and fixed the Metro file watcher timeout issue on Windows/OneDrive
- Updated CLAUDE.md with comprehensive Expo web startup documentation (working method, known issues, pitfalls)
- Updated `C:\tmp\start-expo-web.bat` batch file for manual use
- Successfully compiled the full web bundle (3900+ modules in 52s)

## Decisions
1. **Direct CLI script invocation over `require('@expo/cli')`**
   - **Choix**: Call `node_modules/@expo/cli/build/bin/cli` directly with `node.exe`
   - **Rationale**: Avoids the `-e` script inheritance bug where Metro worker processes also try to start Expo servers. The CLI script is a proper entry point that doesn't pollute child process argv.
   - **Alternative rejetee**: `node -e "require('@expo/cli')"` — works only with warm cache, breaks on cold starts with "Port 19006 is being used by another process" cascade

2. **Patch Metro watcher timeout over installing Watchman**
   - **Choix**: Increase `MAX_WAIT_TIME` from 240000 to 600000 in `metro-file-map/src/Watcher.js`
   - **Rationale**: Quick fix that works immediately. Watchman installation on Windows is complex and may have its own issues. The FallbackWatcher just needs more time on OneDrive's slow filesystem.
   - **Alternative rejetee**: Install Watchman for Windows — more permanent but higher setup cost

3. **Batch file with `node.exe` direct path over `npx`/`npx.cmd`**
   - **Choix**: Use `"C:\Program Files\nodejs\node.exe"` directly in batch file
   - **Rationale**: `npx expo` and `call npx.cmd expo` both fail in `cmd.exe` — the `expo` binary isn't found as a Windows executable. Direct `node.exe` invocation bypasses all PATH resolution issues.
   - **Alternative rejetee**: `npx.cmd expo` via `cmd.exe` — `expo` not recognized as command

## Problems
1. **`npx expo` not found via cmd.exe batch file**
   - **Symptome**: `'expo' n'est pas reconnu en tant que commande interne ou externe`
   - **Cause**: Even with `C:\Program Files\nodejs` in PATH and using `call npx.cmd`, the `expo` CLI script in `node_modules/.bin/` is a shell script (not `.cmd`) that cmd.exe cannot execute
   - **Solution**: Bypass npx entirely — call `node.exe` with the Expo CLI script path directly
   - **Prevention**: Never use `npx` in Windows batch files for locally-installed packages; use `node.exe` + direct module path

2. **Metro FallbackWatcher timeout on Windows/OneDrive**
   - **Symptome**: `Failed to construct transformer: Error: Failed to start watch mode.` at `Watcher.js:161`
   - **Cause**: Metro's `FallbackWatcher` uses `fs.watch()` on every directory via `recReaddir`. On Windows with OneDrive sync (slow NTFS operations), the health check cookie detection takes longer than the 240s `MAX_WAIT_TIME`
   - **Solution**: Patched `MAX_WAIT_TIME` from 240000 to 600000 in `node_modules/metro-file-map/src/Watcher.js`
   - **Prevention**: This patch is lost on `yarn install`. Document in CLAUDE.md. Consider adding a postinstall script to auto-patch, or install Watchman.

3. **`node -e "require('@expo/cli')"` Metro worker cascade (from previous session)**
   - **Symptome**: "Jest worker encountered 4 child process exceptions, exceeding retry limit" + "Port 19006 is being used by another process" flooding
   - **Cause**: When Node.js is started with `-e "script"`, Metro's `child_process.fork()` workers inherit `process.execArgv` which includes the eval flag. Workers re-execute the eval script, each trying to start their own Expo server on port 19006.
   - **Solution**: Use `node.exe ./node_modules/@expo/cli/build/bin/cli` instead — workers fork with the Metro worker script, not the Expo startup script
   - **Prevention**: Never use `node -e` to start long-running servers that spawn child workers. Always use a proper script file entry point.

4. **White page on first load**
   - **Symptome**: User saw blank white page at localhost:19006
   - **Cause**: The browser requested the page before the JS bundle finished compiling (52s cold compilation for 3900+ modules)
   - **Solution**: Wait for compilation to finish, then refresh with F5 or Ctrl+Shift+R
   - **Prevention**: Non-issue — only happens on first cold load. Subsequent loads use cached bundle.

## Modified Files
- `happy/CLAUDE.md` - Modified - Updated "Starting Expo Web from Claude Code (Windows)" section with correct method, known issues, and pitfalls
- `C:\tmp\start-expo-web.bat` - Modified - Updated to use `node.exe` + direct CLI script path instead of `npx`
- `happy/node_modules/metro-file-map/src/Watcher.js` - Modified (node_modules, not tracked) - Increased `MAX_WAIT_TIME` from 240000 to 600000

## User Preferences Observed
### Technical Preferences
- Wants CLAUDE.md updated when discovering correct methods for dev tooling
- Prefers autonomous troubleshooting — didn't ask for help, just reported "c'est tout blanc"
- Tolerant of iterative debugging approach (multiple failed attempts before success)

## Code Patterns
### Architecture
- Metro bundler on Windows uses `FallbackWatcher` (not Watchman, not NativeWatcher which is macOS-only)
- `FallbackWatcher` walks entire directory tree with `recReaddir` and creates `fs.watch()` per directory
- Health check mechanism: write a cookie file, wait for watcher to detect it within `MAX_WAIT_TIME`
- Expo CLI entry point: `node_modules/@expo/cli/build/bin/cli` (JavaScript file, not shell script)

### Windows/OneDrive Specifics
- OneDrive NTFS operations are significantly slower than local disk
- `cmd.exe` cannot execute shell scripts in `node_modules/.bin/` — only `.cmd` wrappers
- `npx.cmd` exists but `expo` resolution still fails because the local binary is a shell script
- `child_process.fork()` inherits `process.execArgv` (including `-e` flag) but NOT `process.argv`

## Next
- Test remaining web features via HydraSpecter (CSV Viewer, SQLite Viewer, Markdown Preview, Mermaid) using the test files created in the previous session
- Consider adding a postinstall script to auto-patch Metro's `MAX_WAIT_TIME`
- Consider installing Watchman for Windows as a more permanent fix
- Commit the CLAUDE.md update
- The Expo web server is running on PID 101448 — task `bb7dd08` in background

## References
- Metro file watcher code: `node_modules/metro-file-map/src/Watcher.js` (lines 127-180)
- FallbackWatcher: `node_modules/metro-file-map/src/watchers/FallbackWatcher.js`
- NativeWatcher (macOS only): `node_modules/metro-file-map/src/watchers/NativeWatcher.js`
- Expo CLI entry point: `node_modules/@expo/cli/build/bin/cli`
- Batch file: `C:\tmp\start-expo-web.bat`
- Previous testing session diary: `docs/rapports/2026.02.24_18.07_8dedb51_SESSION_hydraspecter-web-feature-testing.md`
