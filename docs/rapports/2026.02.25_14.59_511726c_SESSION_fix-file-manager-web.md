# Session: Fix File Manager RPC null crash + offline UX on web

## Metadata
- **Date**: 2026-02-25 ~14:00
- **Duration**: ~2 hours (across 2 context windows - this is the continuation)
- **Commit(s)**: 511726c3
- **Project**: C:\Users\julien\OneDrive\Coding\_Projets de code\2026.01 Happy (Claude Code remote)
- **Branch**: master
- **Tech Stack**: React Native, Expo Router, TypeScript, Socket.io, HydraSpecter (browser testing)

## Objective
Make the file manager work on web for online sessions and show a clear offline message for offline sessions, instead of crashing with `Cannot read properties of null (reading 'success')`.

## Achievements
- Fixed null crash in RPC chain (`decryptRaw()` returning null silently passing through)
- Added offline session guard in `useFileManager.ts` (skip RPC if session inactive)
- Added offline UI in `file-manager.tsx` ("Session is offline" message with plug icon)
- Added `sessionOffline` + `sessionOfflineHelp` i18n translations in all 9 languages
- Auto-refresh when session comes back online
- Verified file manager works on web via HydraSpecter (sidebar + tree view renders correctly for online sessions)

## Decisions
1. **3-level null safety defense**
   - **Choix**: Add null checks in `apiSocket.ts` (throw on null decrypt), `ops.ts` (guard in sessionGetDirectoryTree), and `useFileManager.ts` (guard on response)
   - **Rationale**: Defense in depth - apiSocket fix protects all RPC callers, ops.ts protects specific function, useFileManager protects the UI
   - **Alternative rejetee**: Only fixing apiSocket.ts - sufficient but fragile if decryptRaw behavior changes

2. **Online guard placement**
   - **Choix**: Guard in `useFileManager.ts` loadTree callback + expose `isOnline` to screen
   - **Rationale**: File manager is the primary entry point; other screens (file editor, markdown preview) are navigated TO from file manager, so guarding here prevents dead-end RPC screens
   - **Alternative rejetee**: Shared `useRequireOnlineSession` hook - overkill for now, only file manager needed it

## Problems
1. **RPC null crash on web**
   - **Symptome**: `Cannot read properties of null (reading 'success')` when navigating to file manager on web
   - **Cause**: `sessionEncryption.decryptRaw(result.result)` in `apiSocket.ts` returns null without throwing. Null passes through `ops.ts` try-catch (only catches thrown errors). `useFileManager.ts` then crashes accessing `.success` on null.
   - **Solution**: Added `if (decrypted == null) throw new Error('RPC response decryption returned null')` in both `sessionRPC` and `machineRPC`
   - **Prevention**: Always check return values of decrypt operations, not just catch blocks

2. **Web navigation appeared broken (previous context window)**
   - **Symptome**: Clicking sessions in list didn't navigate, deep links didn't work
   - **Cause**: Likely a stale browser instance issue - in this continuation session, navigation worked fine after fresh page load
   - **Solution**: Fresh browser navigation resolved it; the Expo Router drawer layout works correctly on web

3. **CORS blocking API requests**
   - **Symptome**: `Access-Control-Allow-Origin` errors for `api.cluster-fluster.com` from `localhost:19006`
   - **Cause**: Server-side CORS headers not configured for localhost
   - **Solution**: Not fixed (server-side issue). Socket.io initial connection succeeds; CORS errors are from reconnection attempts after WebSocket 502. File manager works despite these errors.

## Modified Files
- `happy/sources/sync/apiSocket.ts` - Modified - null check after decryptRaw in sessionRPC + machineRPC
- `happy/sources/sync/ops.ts` - Modified - null guard in sessionGetDirectoryTree
- `happy/sources/hooks/useFileManager.ts` - Modified - offline guard, null guard on response, expose isOnline
- `happy/sources/app/(app)/session/[id]/file-manager.tsx` - Modified - offline UI, auto-refresh on reconnect
- `happy/sources/text/_default.ts` - Modified - sessionOffline + sessionOfflineHelp keys
- `happy/sources/text/translations/{en,ru,pl,es,ca,it,ja,pt,zh-Hans}.ts` - Modified - translated strings

## User Preferences Observed
### Technical Preferences
- Use HydraSpecter's dedicated tools (`browser_get_element_text`, `browser_get_markdown`, `browser_find_element`) instead of `browser_evaluate` for DOM inspection
- Prefer concise, direct communication in French when user writes in French

## Code Patterns
### Architecture
- RPC relay chain: Web app -> socket.io -> api.cluster-fluster.com -> CLI process -> filesystem
- Offline guard pattern: check `storage.getState().sessions[sessionId]?.active` before RPC calls
- Defense in depth: null safety at multiple layers (transport, operation, hook)

### Style
- Error sentinel values: `'session_offline'` used as error string to distinguish from actual RPC errors
- Auto-refresh on reconnect: `useRef` + `useEffect` pattern tracking previous online state

## Next
- **CORS fix on server**: `api.cluster-fluster.com` needs `Access-Control-Allow-Origin` for `localhost:19006` (or `*` for dev)
- **WebSocket 502 on reconnection**: Server reverse proxy (likely nginx) returns 502 on WebSocket handshake during reconnection
- **Android deployment**: Changes are JS-only, can be deployed via OTA (`eas update --branch production`)
- **Apply offline guard to other RPC screens**: file.tsx, markdown-preview.tsx (low priority - file manager guards the entry point)

## References
- Plan: `C:\Users\julien\.claude\plans\snuggly-dancing-newell.md`
- Previous session: investigated and identified the null crash root cause
- HydraSpecter browser instance `pl-39f1b14a` used for web testing
